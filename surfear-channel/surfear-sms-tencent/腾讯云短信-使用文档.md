## 阿里云短信-使用文档

----------

### 官方文档

[腾讯云官方文档-发送短信](https://cloud.tencent.com/document/api/382/55981)

[腾讯云官方文档-短信状态回调配置](https://cloud.tencent.com/document/product/382/37809)

----------

### 功能支持

----------

| 消息/功能类型      | 是否支持 | 模板支持  | 模板支持度                          | 特色功能 |
|--------------|------|-------|--------------------------------|------|
| 发送短信接口 | 是    | 是（可选） | 只支持txt格式 | 本地日志 |
| 拉取单个号码短信下发状态       | 是  | -     | -                              | 接口封装 |
| 状态回调       | 是    | -     | -                              | 回调封装 |
| 上行回调       | 是    | -     | -                              | 回调封装 |


### 特色功能

----------

- 数据结构抽象：提供统一的数据结构抽象，简化消息发送逻辑
- 模板支持：支持txt模板类型，便于本地快速预览短信模板，并打印短信内容日志
- 模板变量支持：支持模板变量语法${var}填充，方便动态消息内容生成。变量未赋值将原样输出。
- 接口/回调简易封装：两行代码调用，轻松获取结果
----------

### 使用示例

----------
### Maven引用

```xml
<dependency>
    <groupId>io.github.yangdaowan</groupId>
    <artifactId>surfear-sms-tencent</artifactId>
    <version>${surfear.version}</version>
</dependency>
```

----------

### 配置文件
在 `resources/surfear.yml` 中添加以下配置：
```yaml
surfear:
  # 腾讯云
  tencent:
    # 接口凭证
    secretId: "AKIDjKivxmP0Xxxxxxxxxxxxxxxx"
    secretKey: "4uXxJUTFo92thxxxxxxxxxxxxxxx"
```
配置项参考
```java
io.github.yangdaowan.surfear.sms.tencent.framework.TencentConfig
```

- 支持多环境配置：
  - 临时配置 > 环境变量 > 项目配置 > 默认配置
- 支持多项目配置文件：
  - `resources/surfear.properties` 及 `resources/surfear.yml`
  - `yml文件`后读取，会覆盖`properties文件`
- 使用参考：顺风耳工具包-配置说明文档.md
----------

### 通道KEY
```java
"sms:tencent"
```

----------

### 使用示例

----------
**模板管理（可选，不设置无影响）**

在使用腾讯云短信服务前，需要先在腾讯云控制台创建短信签名和短信模板。

点击 [短信服务控制台](https://console.cloud.tencent.com/smsv2)，登录并查看已审核通过的短信签名和短信模板。

下面以腾讯云测试短信模板为例。

----------

在 `resources/templates/sms` 目录下添加模板文件：`1110.txt`

```text
您正在使用阿里云短信测试服务，体验验证码是：${0}，如非本人操作，请忽略本短信！
```
注意当前通道为`SMS`类型，所以模板文件需要放在`resources/templates/sms`目录下。

----------
**发送短信**
```java
// 消息模型
TencentSmsModel model = new TencentSmsModel();
// 向指定手机号发送短信
model.setPhoneNumberSet(new String[]{"手机号"});
model.setSmsSdkAppId("1400000000"); // 腾讯云短信应用ID
model.setSignName("腾讯云");   // 短信签名
model.setTemplateId("1110");  // 短信模板ID
model.setTemplateParamSet(new String[]{"123456"}); // 模板参数，注意顺序和数量要与模板变量一致

MessageResult result = MessageSender.send("sms:tencent", model);
System.out.println(result);
```
**日志打印**
```text
2025-08-12 22:47:20.883 [main] INFO  i.g.y.s.c.s.log.LoggingInterceptor - [腾讯云短信] : 727b5c2b-1dc5-4112-bd10-c9bf0d98a267
2025-08-12 22:47:21.197 [main] INFO  i.g.y.s.core.spi.message.Message - 向 [xxx] 发送：您正在使用腾讯云短信测试服务，体验验证码是：123456，如非本人操作，请忽略本短信！
```
**响应结果**
```json
{
  "code": "0",
  "data": {
    "Response": {
      "SendStatusSet": [
        {
          "SerialNo": "5000:1045710669157053657849499619",
          "PhoneNumber": "+8618501234444",
          "Fee": 1,
          "SessionContext": "outsid_1729495320_1011",
          "Code": "Ok",
          "Message": "send success",
          "IsoCode": "CN"
        },
        {
          "SerialNo": "",
          "PhoneNumber": "xxx",
          "Fee": 0,
          "SessionContext": "",
          "Code": "FailedOperation.TemplateUnapprovedOrNotExist",
          "Message": "template is not approved or not exist",
          "IsoCode": ""
        }
      ],
      "RequestId": "30f6934c-a805-4999-9d73-03b6b5cfd952"
    },
    "messageId": "d0bf2ea6-42af-4f5d-85e4-c05e48968a07"
  },
  "message": "ok",
  "success": true
}
```

----------
**查询短信**
```java
// 取发送前时间（该接口属于范围查询）
long unixTimestamp = Instant.now().getEpochSecond();

TencentSmsQueryModel queryModel = new TencentSmsQueryModel();
queryModel.setPhoneNumber("xxxx");
queryModel.setBeginTime(unixTimestamp);
queryModel.setSmsSdkAppId("1400000000"); // 腾讯云短信应用ID
queryModel.setOffset(0);
queryModel.setLimit(2);

// 方式一：手动设置配置
// TencentConfig config = new TencentConfig("secretId", "secretKey");
// 方式二：从项目中获取配置
TencentConfig config = ConfigUtil.getChannelConfigObject(null, TencentConfig.class);

TencentQuerySendApi querySendApi = new TencentQuerySendApi(config, queryModel);
JSONObject response = querySendApi.parseResponse(new OkhttpClient().execute(querySendApi));
System.out.println(response);
```
**响应结果**
```json
{
  "Response": {
    "PullSmsSendStatusSet": [
      {
        "Description": "DELIVRD",
        "CountryCode": "86",
        "SubscriberNumber": "18501234444",
        "ReportStatus": "SUCCESS",
        "PhoneNumber": "+8618501234444",
        "SerialNo": "5000:1045710669157053657849499619",
        "UserReceiveTime": 1620734188,
        "SessionContext": ""
      },
      {
        "Description": "DELIVRD",
        "CountryCode": "86",
        "SubscriberNumber": "18501234444",
        "ReportStatus": "SUCCESS",
        "PhoneNumber": "+8618501234444",
        "SerialNo": "5000:1045710669157053657849498556",
        "UserReceiveTime": 1620734188,
        "SessionContext": ""
      }
    ],
    "RequestId": "8979fc1e-9564-4fc9-bf7d-2958ce679b72"
  }
}
```
----------
**回调接收**
```java
// 默认配置
TencentSmsCallbackConfig config = new TencentSmsCallbackConfig();

// 启动服务
TencentSmsCallbackServer server = new TencentSmsCallbackServer(config, new SmsCallbackHandler<JSONArray>() {
    @Override
    public void handleStatusReport(JSONArray callbackData) {
      System.out.println("接收到状态回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUplinkMessage(JSONArray callbackData) {
      System.out.println("接收到上行回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUnknownCallback(JSONArray callbackData) {
      System.out.println("接收到未知回调: " + callbackData.toJSONString());
    }
});
server.start();
```

**测试方法**
```java
@Test
public void testCallback() throws IOException {
    // 默认配置
    TencentSmsCallbackConfig config = new TencentSmsCallbackConfig();
  
    // 启动服务
    TencentSmsCallbackServer server = TencentSmsCallbackServer.createInstance(config, new SmsCallbackHandler<JSONArray>() {
      @Override
      public void handleStatusReport(JSONArray callbackData) {
        System.out.println("接收到状态回调: " + callbackData.toJSONString());
      }
  
      @Override
      public void handleUplinkMessage(JSONArray callbackData) {
        System.out.println("接收到上行回调: " + callbackData.toJSONString());
      }
  
      @Override
      public void handleUnknownCallback(JSONArray callbackData) {
        System.out.println("接收到未知回调: " + callbackData.toJSONString());
      }
    });
    server.start().join();
  
    // 请求数据
    JSONObject body = new JSONObject();
    // 状态回调
    body.put("user_receive_time", "2015-10-17 08:03:04");
    body.put("nationcode", "86");
    body.put("mobile", "13xxxxxxxxx");
    body.put("report_status", "SUCCESS");
    body.put("errmsg", "DELIVRD");
    body.put("description", "用户短信送达成功");
    body.put("sid", "xxxxxxx");
    // 上行回调
  //        body.put("extend", "扩展码");
  //        body.put("mobile", "13xxxxxxxxx");
  //        body.put("nationcode", "86");
  //        body.put("sign", "短信签名");
  //        body.put("text", "用户回复的内容");
  //        body.put("time", 1457336869);
  
    URL url = new URL("http://localhost:" + config.getPort() + config.getPath());
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
  
    try {
      connection.setRequestMethod("POST");
      connection.setDoOutput(true);
  
      // 发送请求体
      try (OutputStream os = connection.getOutputStream()) {
        os.write(new JSONArray(body).toJSONString().getBytes(StandardCharsets.UTF_8));
      }
  
      // 获取响应
      int responseCode = connection.getResponseCode();
      String responseBody;
  
      try (InputStream is = connection.getInputStream();
           ByteArrayOutputStream bos = new ByteArrayOutputStream()) {
        byte[] buffer = new byte[1024];
        int length;
        while ((length = is.read(buffer)) != -1) {
          bos.write(buffer, 0, length);
        }
        responseBody = bos.toString("UTF-8");
      }
  
      // 打印响应信息
      System.out.println("Response : " + responseCode + " , " + responseBody);
  
    } finally {
      connection.disconnect();
    }
}
```
**日志打印**
```text
2025-08-12 23:36:18.565 [main] INFO  i.g.y.s.c.o.s.AbstractSmsCallbackServer - [腾讯云短信] - 回调服务启动 http://localhost:21002/tencent/sms/callback
2025-08-12 23:36:18.762 [Thread-3] DEBUG i.g.y.s.s.t.c.a.c.TencentSmsCallbackServer - [腾讯云短信] - 收到回调请求: [{"user_receive_time":"2015-10-17 08:03:04","nationcode":"86","mobile":"13xxxxxxxxx","report_status":"SUCCESS","errmsg":"DELIVRD","description":"用户短信送达成功","sid":"xxxxxxx"}]
接收到状态回调: [{"user_receive_time":"2015-10-17 08:03:04","nationcode":"86","mobile":"13xxxxxxxxx","report_status":"SUCCESS","errmsg":"DELIVRD","description":"用户短信送达成功","sid":"xxxxxxx"}]
Response : 200 , {"result":0,"errmsg":"OK"}

2025-08-12 23:38:21.659 [main] INFO  i.g.y.s.c.o.s.AbstractSmsCallbackServer - [腾讯云短信] - 回调服务启动 http://localhost:21002/tencent/sms/callback
2025-08-12 23:38:21.995 [Thread-2] DEBUG i.g.y.s.s.t.c.a.c.TencentSmsCallbackServer - [腾讯云短信] - 收到回调请求: [{"extend":"扩展码","mobile":"13xxxxxxxxx","nationcode":"86","sign":"短信签名","text":"用户回复的内容","time":1457336869}]
接收到上行回调: [{"extend":"扩展码","mobile":"13xxxxxxxxx","nationcode":"86","sign":"短信签名","text":"用户回复的内容","time":1457336869}]
Response : 200 , {"result":0,"errmsg":"OK"}
```