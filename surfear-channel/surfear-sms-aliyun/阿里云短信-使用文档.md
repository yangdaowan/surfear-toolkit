## 阿里云短信-使用文档

----------

### 官方文档

[阿里云官方文档-发送短信接口](https://next.api.aliyun.com/document/Dysmsapi/2017-05-25/SendSms)

[阿里云官方文档-回执消息配置](https://help.aliyun.com/zh/sms/developer-reference/configure-delivery-receipts-1?spm=a2c4g.11186623.help-menu-44282.d_5_4_0.2006b392FnhMlJ)

----------

### 功能支持

----------

| 消息/功能类型      | 是否支持 | 模板支持  | 模板支持度                          | 特色功能 |
|--------------|------|-------|--------------------------------|------|
| 发送短信接口 | 是    | 是（可选） | 只支持txt格式 | 本地日志 |
| 查询短信接口       | 是  | -     | -                              | 接口封装 |
| 状态回调       | 是    | -     | -                              | 回调封装 |
| 上行回调       | 是    | -     | -                              | 回调封装 |


### 特色功能

----------

- 数据结构抽象：提供统一的数据结构抽象，简化消息发送逻辑
- 模板支持：支持txt模板类型，便于本地快速预览短信模板，并打印短信内容日志
- 模板变量支持：支持模板变量语法${var}填充，方便动态消息内容生成。变量未赋值将原样输出。
- 接口/回调简易封装：两行代码调用，轻松获取结果
----------

### 使用示例

----------
### Maven引用

```xml
<dependency>
    <groupId>io.github.yangdaowan</groupId>
    <artifactId>surfear-sms-aliyun</artifactId>
    <version>${surfear.version}</version>
</dependency>
```

----------

### 配置文件
在 `resources/surfear.yml` 中添加以下配置：
```yaml
surfear:
  # 阿里云
  aliyun:
    # 应用凭证
    accessKey: "LTAI5tSh8axxxxxxxxxxxxx"
    secretKey: "63MlHhOWJgc77Xo2xxxxxxxxxxxxx"
```
配置项参考
```java
io.github.yangdaowan.surfear.sms.aliyun.framework.AliyunConfig
```

- 支持多环境配置：
  - 临时配置 > 环境变量 > 项目配置 > 默认配置
- 支持多项目配置文件：
  - `resources/surfear.properties` 及 `resources/surfear.yml`
  - `yml文件`后读取，会覆盖`properties文件`
- 使用参考：顺风耳工具包-配置说明文档.md
----------

### 通道KEY
```java
"sms:aliyun"
```

----------

### 使用示例

----------
**模板管理（可选，不设置无影响）**

在使用阿里云短信服务前，需要先在阿里云控制台创建短信签名和短信模板。

点击 [短信服务控制台](https://dysms.console.aliyun.com/domestic/text/template?spm=api-workbench.API%20Document.0.0.5be31c6cMrNHrg)，登录并查看已审核通过的短信签名和短信模板。

下面以阿里云测试短信模板为例。

----------

在 `resources/templates/sms` 目录下添加模板文件：`SMS_154950909.txt`

```text
您正在使用阿里云短信测试服务，体验验证码是：${code}，如非本人操作，请忽略本短信！
```
注意当前通道为`SMS`类型，所以模板文件需要放在`resources/templates/sms`目录下。

----------
**发送短信**
```java
// 消息模型
AliyunSmsModel model = new AliyunSmsModel();
// 向多个手机号发送相同内容的短信
// model.setPhoneNumbers(String.join(",", Arrays.asList("手机号1","手机号2","手机号3", "手机号4")));
// 向单个手机号发送短信
model.setPhoneNumbers("手机号");
model.setSignName("阿里云短信测试");
model.setTemplateCode("SMS_154950909");

Map<String, Object> templateParam = new HashMap<>();
templateParam.put("code", "1234");
model.setTemplateParam(templateParam);

MessageResult result = MessageSender.send("sms:aliyun", model);
System.out.println(result);
```
**日志打印**
```text
2025-08-09 05:32:40.100 [main] INFO  i.g.y.s.c.s.log.LoggingInterceptor - [阿里云短信] : f22f452b-646e-47f2-87be-e155aefc88c2
2025-08-09 05:32:40.353 [main] INFO  i.g.y.s.core.spi.message.Message - 向 [xxx] 发送：您正在使用阿里云短信测试服务，体验验证码是：1234，如非本人操作，请忽略本短信！
```
**响应结果**
```json
{
  "code": "200",
  "data": {
    "Message": "OK",
    "RequestId": "EE1A66B4-098F-5938-B358-000F746875FF",
    "Code": "OK",
    "BizId": "799106854688761509^0",
    "messageId": "f22f452b-646e-47f2-87be-e155aefc88c2"
  },
  "message": "ok",
  "success": true
}
```

----------
**查询短信**
```java
String bizId = "799106854688761509^0";
// 取当前日期，最好是接收短信结果后立即存储接收时间来计算，注意规避0点日期边界问题。
SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");

AliyunSmsQueryModel queryModel = new AliyunSmsQueryModel();
queryModel.setPhoneNumber("手机号");
queryModel.setSendDate(sdf.format(new Date()));
queryModel.setBizId(bizId);
queryModel.setPageSize(1);
queryModel.setCurrentPage(1);


// 方式一：手动设置配置
// AliyunConfig config = new AliyunConfig("accessKey", "secretKey");
// 方式二：从项目中获取配置
AliyunConfig config = ConfigUtil.getChannelConfigObject(null, AliyunConfig.class);

AliyunQuerySendApi querySendApi = new AliyunQuerySendApi(config, queryModel);
JSONObject response = querySendApi.parseResponse(new OkhttpClient().execute(querySendApi));
System.out.println(response);
```
**响应结果**
```json
{
  "TotalCount": 1,
  "Message": "OK",
  "RequestId": "0CEAE190-E938-58DC-953B-21EB1BA61555",
  "Code": "OK",
  "SmsSendDetailDTOs": {
    "SmsSendDetailDTO": [
      {
        "ReceiveDate": "2025-08-09 05:32:48",
        "PhoneNum": "手机号",
        "Content": "【阿里云短信测试】您正在使用阿里云短信测试服务，体验验证码是：1234，如非本人操作，请忽略本短信！",
        "SendStatus": 3,
        "SendDate": "2025-08-09 05:32:41",
        "ErrCode": "DELIVERED"
      }
    ]
  }
}
```
结果参考
```json
{
  "ErrCode": {
    "description": "运营商短信状态码。\n\n-  短信发送成功：DELIVERED。\n-  短信发送失败：失败错误码请参见[错误码](~~101347~~)。",
    "type": "string",
    "example": "DELIVERED"
  },
  "TemplateCode": {
    "description": "短信模板Code。\n\n\u003E 若选择`[测试专用]阿里云通信`和`[测试专用]阿里云通信测试模板`发送的测试短信，本接口将不会返回TemplateCode字段。",
    "type": "string",
    "example": "SMS_12231****"
  },
  "OutId": {
    "description": "外部流水扩展字段。\n\n\u003E 若发送短信时未传入OutId，本接口将不会返回OutId字段。",
    "type": "string",
    "example": "123"
  },
  "ReceiveDate": {
    "description": "短信接收日期和时间。",
    "type": "string",
    "example": "2025-06-01 16:44:13"
  },
  "SendDate": {
    "description": "短信发送日期和时间。",
    "type": "string",
    "example": "2025-06-01 16:44:10"
  },
  "PhoneNum": {
    "description": "接收短信的手机号码。",
    "type": "string",
    "example": "1390000****"
  },
  "Content": {
    "description": "短信内容。",
    "type": "string",
    "example": "【阿里云】验证码为：123，您正在登录，若非本人操作，请勿泄露"
  },
  "SendStatus": {
    "description": "短信发送状态，包括：\n\n- **1**：等待回执。\n- **2**：发送失败。\n- **3**：发送成功。",
    "type": "integer",
    "format": "int64",
    "example": "3"
  }
}
```
----------
**回调接收**
```java
// 使用默认配置
AliyunSmsCallbackConfig config = new AliyunSmsCallbackConfig();

// 启动服务
AliyunSmsCallbackServer server = new AliyunSmsCallbackServer(config, new SmsCallbackHandler<JSONArray>() {
    @Override
    public void handleStatusReport(JSONArray callbackData) {
      System.out.println("接收到状态回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUplinkMessage(JSONArray callbackData) {
      System.out.println("接收到上行回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUnknownCallback(JSONArray callbackData) {
      System.out.println("接收到未知回调: " + callbackData.toJSONString());
    }
});
server.start();
```

**测试方法**
```java
@Test
public void testCallback() throws IOException {
    // 使用默认配置
    AliyunSmsCallbackConfig config = new AliyunSmsCallbackConfig();
  
    // 启动服务
    AliyunSmsCallbackServer server = AliyunSmsCallbackServer.createInstance(config, new SmsCallbackHandler<JSONArray>() {
      @Override
      public void handleStatusReport(JSONArray callbackData) {
        System.out.println("接收到状态回调: " + callbackData.toJSONString());
      }
  
      @Override
      public void handleUplinkMessage(JSONArray callbackData) {
        System.out.println("接收到上行回调: " + callbackData.toJSONString());
      }
  
      @Override
      public void handleUnknownCallback(JSONArray callbackData) {
        System.out.println("接收到未知回调: " + callbackData.toJSONString());
      }
    });
    server.start().join();
  
    // 请求数据
    JSONObject body = new JSONObject();
    // 状态回调
    body.put("phone_number", "1381111****");
    body.put("send_time", "2017-01-01 00:00:00");
    body.put("report_time", "2017-01-01 00:00:00");
    body.put("success", true);
    body.put("err_code", "DELIVERED");
    body.put("err_msg", "用户接收成功");
    body.put("sms_size", "1");
    body.put("biz_id", "12345********");
    body.put("out_id", "67890**");
    // 上行回调
  //        body.put("phone_number", "1381111****");
  //        body.put("content", "内容");
  //        body.put("send_time", "2017-09-01 00:00:00");
  //        body.put("dest_code", "1234");
  //        body.put("sequence_id", "1234567890");
  
    URL url = new URL("http://localhost:" + config.getPort() + config.getPath());
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
  
    try {
      connection.setRequestMethod("POST");
      connection.setDoOutput(true);
  
      // 发送请求体
      try (OutputStream os = connection.getOutputStream()) {
        os.write(new JSONArray(body).toJSONString().getBytes(StandardCharsets.UTF_8));
      }
  
      // 获取响应
      int responseCode = connection.getResponseCode();
      String responseBody;
  
      try (InputStream is = connection.getInputStream();
           ByteArrayOutputStream bos = new ByteArrayOutputStream()) {
        byte[] buffer = new byte[1024];
        int length;
        while ((length = is.read(buffer)) != -1) {
          bos.write(buffer, 0, length);
        }
        responseBody = bos.toString("UTF-8");
      }
  
      // 打印响应信息
      System.out.println("Response : " + responseCode + " , " + responseBody);
  
    } finally {
      connection.disconnect();
    }
}
```
**日志打印**
```text
2025-08-12 19:01:39.667 [main] INFO  i.g.y.s.c.o.s.AbstractSmsCallbackServer - [阿里云短信] - 回调服务启动 http://localhost:21001/aliyun/sms/callback
2025-08-12 19:01:39.851 [Thread-3] DEBUG i.g.y.s.s.a.c.a.c.AliyunSmsCallbackServer - [阿里云短信] - 收到回调请求: [{"phone_number":"1381111****","send_time":"2017-01-01 00:00:00","report_time":"2017-01-01 00:00:00","success":true,"err_code":"DELIVERED","err_msg":"用户接收成功","sms_size":"1","biz_id":"12345********","out_id":"67890**"}]
接收到状态回调: [{"phone_number":"1381111****","send_time":"2017-01-01 00:00:00","report_time":"2017-01-01 00:00:00","success":true,"err_code":"DELIVERED","err_msg":"用户接收成功","sms_size":"1","biz_id":"12345********","out_id":"67890**"}]
Response : 200 , {"code":0,"msg":"OK"}

2025-08-12 19:05:21.981 [main] INFO  i.g.y.s.c.o.s.AbstractSmsCallbackServer - [阿里云短信] - 回调服务启动 http://localhost:21001/aliyun/sms/callback
2025-08-12 19:05:22.240 [Thread-3] DEBUG i.g.y.s.s.a.c.a.c.AliyunSmsCallbackServer - [阿里云短信] - 收到回调请求: [{"phone_number":"1381111****","content":"内容","send_time":"2017-09-01 00:00:00","dest_code":"1234","sequence_id":"1234567890"}]
接收到上行回调: [{"phone_number":"1381111****","content":"内容","send_time":"2017-09-01 00:00:00","dest_code":"1234","sequence_id":"1234567890"}]
Response : 200 , {"code":0,"msg":"OK"}
```