## 百度云短信-使用文档

----------

### 官方文档

[百度云官方文档-短信下发](https://cloud.baidu.com/doc/SMS/s/lkijy5wvf)

----------

### 功能支持

----------

| 消息/功能类型      | 是否支持 | 模板支持  | 模板支持度                          | 特色功能 |
|--------------|------|-------|--------------------------------|------|
| 短信下发 | 是    | 是（可选） | 只支持txt格式 | 本地日志 |
| 状态回调       | 是    | -     | -                              | 回调封装 |
| 上行回调       | 是    | -     | -                              | 回调封装 |


### 特色功能

----------

- 数据结构抽象：提供统一的数据结构抽象，简化消息发送逻辑
- 模板支持：支持txt模板类型，便于本地快速预览短信模板，并打印短信内容日志
- 模板变量支持：支持模板变量语法${var}填充，方便动态消息内容生成。变量未赋值将原样输出。
- 回调简易封装：两行代码调用，轻松获取结果
----------

### 使用示例

----------
### Maven引用

```xml
<dependency>
    <groupId>io.github.yangdaowan</groupId>
    <artifactId>surfear-sms-baidu</artifactId>
    <version>${surfear.version}</version>
</dependency>
```

----------

### 配置文件
在 `resources/surfear.yml` 中添加以下配置：
```yaml
surfear:
  # 百度云
  baidu:
    # 应用凭证
    accessKey: "0b7246d8394545xxxxxxxxxxxxx"
    secretKey: "df562966c1de44c0aaca8bxxxxxxxxxxxxx"
```
配置项参考
```java
io.github.yangdaowan.surfear.sms.baidu.framework.BaiduConfig
```

- 支持多环境配置：
  - 临时配置 > 环境变量 > 项目配置 > 默认配置
- 支持多项目配置文件：
  - `resources/surfear.properties` 及 `resources/surfear.yml`
  - `yml文件`后读取，会覆盖`properties文件`
- 使用参考：顺风耳工具包-配置说明文档.md
----------

### 通道KEY
```java
"sms:baidu"
```

----------

### 使用示例

----------
**模板管理（可选，不设置无影响）**

在使用百度云短信服务前，需要先在百度云控制台创建短信签名和短信模板。

必须为企业主体认证用户，个人用户无法使用短信服务。

点击 [短信服务控制台](https://console.bce.baidu.com/smsv3/#/smsv3/landing)，登录并查看已审核通过的短信签名和短信模板。

下面以百度云测试短信模板为例。

----------

在 `resources/templates/sms` 目录下添加模板文件：`sms-tmpl-awKvRY85349.txt`

```text
您正在使用百度云短信测试服务，体验验证码是：${code}，验证码将于${minute}分钟后失效，如非本人操作，请忽略本短信！
```
注意当前通道为`SMS`类型，所以模板文件需要放在`resources/templates/sms`目录下。

----------
**发送短信**
```java
// 消息模型
BaiduSmsModel model = new BaiduSmsModel();
// 向多个手机号发送相同内容的短信
// model.setPhoneNumbers(String.join(",", Arrays.asList("手机号1","手机号2","手机号3", "手机号4")));
// 向单个手机号发送短信
model.setPhoneNumbers("手机号");
model.setSignatureId("sms-signQxkiwz88470");
model.setTemplate("sms-tmpl-awKvRY85349");

Map<String, Object> contentVar = new HashMap<>();
contentVar.put("code", "23456");
contentVar.put("minute", "1");
model.setContentVar(contentVar);

MessageResult result = MessageSender.send("sms:baidu", model);
System.out.println(result);
```
**日志打印**
```text
2025-08-12 15:35:48.419 [main] INFO  i.g.y.s.c.s.log.LoggingInterceptor - [百度云短信] : 498f486a-d039-4b2e-ad4f-d82aff10bdbd
2025-08-12 15:35:48.856 [main] INFO  i.g.y.s.core.spi.message.Message - 向 [xxx] 发送：您正在使用百度云短信测试服务，体验验证码是：23456，验证码将于1分钟后失效，如非本人操作，请忽略本短信！
```
**响应结果**
```json
{
  "code": "200",
  "data": {
    "requestId": "5e6dacd5-8815-4183-8255-4ff079bf24e6",
    "code": "1000",
    "message": "成功",
    "data": [
      {
        "code": "1000",
        "message": "成功",
        "mobile": "xxx",
        "messageId": "e325ea68-02c1-47ad-8844-c7b93cafaeba_13800138000"
      }
    ]
  },
  "message": "ok",
  "success": true
}
```

----------
**回调接收**
```java
// 使用默认配置
BaiduSmsCallbackConfig config = new BaiduSmsCallbackConfig();

// 启动服务
BaiduSmsCallbackServer server = new BaiduSmsCallbackServer(config, new SmsCallbackHandler<JSONObject>() {
    @Override
    public void handleStatusReport(JSONObject callbackData) {
      System.out.println("接收到状态回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUplinkMessage(JSONObject callbackData) {
      System.out.println("接收到上行回调: " + callbackData.toJSONString());
    }
  
    @Override
    public void handleUnknownCallback(JSONObject callbackData) {
      System.out.println("接收到未知回调: " + callbackData.toJSONString());
    }
});
server.start();
```

**测试方法**
```java
@Test
public void testCallback() throws IOException {
    // 获取配置
    BaiduSmsCallbackConfig config = new BaiduSmsCallbackConfig();

    // 启动服务器（保持不变）
    BaiduSmsCallbackServer server = BaiduSmsCallbackServer.createInstance(config, new SmsCallbackHandler<JSONObject>() {
        @Override
        public void handleStatusReport(JSONObject callbackData) {
          System.out.println("接收到状态回调: " + callbackData.toJSONString());
        }
    
        @Override
        public void handleUplinkMessage(JSONObject callbackData) {
          System.out.println("接收到上行回调: " + callbackData.toJSONString());
        }
    
        @Override
        public void handleUnknownCallback(JSONObject callbackData) {
          System.out.println("接收到未知回调: " + callbackData.toJSONString());
        }
    });
    server.start().join();
    
    // 请求数据
    JSONObject body = new JSONObject();
    // 状态回调
    body.put("requestTime", "2019-12-03T22:53:00Z");
    body.put("deliverTime", "2019-12-03T22:53:05Z");
    body.put("code", "0");
    body.put("requestId", "a6d5f1d9ca2048e5a5454e75da1db563");
    body.put("custom", "example custom");
    body.put("carrierCode", "DELIVRD");
    body.put("mobile", "13800138000");
    body.put("messageId", "c5366f96477b49ca90bcdff2516fe521");
    // 上行回调
//        body.put("mobile", "13800138000");
//        body.put("content", "TD");
//        body.put("sign", "百度云");
//        body.put("receiveTime", "2019-12-03T22:53:05Z");

    URL url = new URL("http://localhost:" + config.getPort() + config.getPath());
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();

    try {
        connection.setRequestMethod("POST");
        connection.setDoOutput(true);

        // 状态回调
        connection.setRequestProperty("signature", "cc2cd0fadda4c848be5006a20323efe2");
        // 上行回调
//            connection.setRequestProperty("signature", "92a7aa614cb0564387039f702a677d29");

        connection.setRequestProperty("requestId", "71bdbef0ac8847378da21ecb142a14e7");
        connection.setRequestProperty("timestamp", "1597320812102");
        connection.setRequestProperty("Content-Type", "application/json;charset=utf-8");
        
        // 发送请求体
        try (OutputStream os = connection.getOutputStream()) {
            os.write(body.toJSONString().getBytes(StandardCharsets.UTF_8));
        }

        // 获取响应
        int responseCode = connection.getResponseCode();
        String responseBody;

        try (InputStream is = connection.getInputStream();
             ByteArrayOutputStream bos = new ByteArrayOutputStream()) {
            byte[] buffer = new byte[1024];
            int length;
            while ((length = is.read(buffer)) != -1) {
                bos.write(buffer, 0, length);
            }
            responseBody = bos.toString("UTF-8");
        }

        // 打印响应信息
        System.out.println("Response : " + responseCode + " , " + responseBody);

    } finally {
        connection.disconnect();
    }
}
```
**日志打印**
```text
2025-08-12 17:46:37.992 [main] INFO  i.g.y.s.s.b.c.s.c.BaiduSmsCallbackServer - [百度云短信] - 回调服务启动 http://localhost:8080/sms/callback
2025-08-12 17:46:38.193 [Thread-3] DEBUG i.g.y.s.s.b.c.s.c.BaiduSmsCallbackServer - [百度云短信] - 收到回调请求: {"mobile":"13800138000","content":"TD","sign":"百度云","receiveTime":"2019-12-03T22:53:05Z"}
接收到上行回调: {"mobile":"13800138000","content":"TD","sign":"百度云","receiveTime":"2019-12-03T22:53:05Z"}
Response : 200 , OK

2025-08-12 17:58:41.984 [main] INFO  i.g.y.s.s.b.c.s.c.BaiduSmsCallbackServer - [百度云短信] - 回调服务启动 http://localhost:8080/sms/callback
2025-08-12 17:58:42.357 [Thread-2] DEBUG i.g.y.s.s.b.c.s.c.BaiduSmsCallbackServer - [百度云短信] - 收到回调请求: {"requestTime":"2019-12-03T22:53:00Z","deliverTime":"2019-12-03T22:53:05Z","code":"0","requestId":"a6d5f1d9ca2048e5a5454e75da1db563","custom":"example custom","carrierCode":"DELIVRD","mobile":"13800138000","messageId":"c5366f96477b49ca90bcdff2516fe521"}
接收到状态回调: {"requestTime":"2019-12-03T22:53:00Z","deliverTime":"2019-12-03T22:53:05Z","code":"0","requestId":"a6d5f1d9ca2048e5a5454e75da1db563","custom":"example custom","carrierCode":"DELIVRD","mobile":"13800138000","messageId":"c5366f96477b49ca90bcdff2516fe521"}
Response : 200 , OK
```